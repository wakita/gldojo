var path = require('path');

var command = process.argv[2];

var argv = [];
for (var i = 2; i < process.argv.length; i++) {
  argv.push(process.argv[i]);
}

var config_path = path.join(process.env['HOME'], '.gldojo', command + '.json');

var default_configuration = {
  glfw: {
    title: "An OpenGL application",
    windowSize: [ 800, 600 ],
    version: [ 4, 3 ],
    sampleRate: 0,
    // flags
    visible:    true,
    fullscreen: false,
    vsync:      false,
    cursor:     true,
    stereo:     false,
    debug:      true
  },

  app: {
    trace: false
  }
};

function configure() {
  var config = default_configuration;

  argv.forEach(function (arg) {
    var flagname;
    if (arg[0] == '+' || arg[0] == '-') {
      var value = arg[0] == '+';
      var args = arg.substring(1).split('.');
      var key = args.pop();
      args.reduce(function (p, k) {
        if (!p[k]) p[k] = {};
        return p[k];
      }, config)[key] = value;
      console.log(key, value);
    } else {
      try {
        console.log('Loading ' + arg + '...');
        require(arg).configure(config);
      } catch (e) {
        console.error('Failed to load module [' + arg + '] not found for the following reason.');
        console.error('    ', e);
        console.error('    Ignored');
      }
    }
  });

  var fs = require('fs');

  if (config.app && config.app.shaders) {
    config.app.shaders.forEach(function (shaders, i, array) {
      var shaderset = {};
      try {
        spec = fs.readFileSync(shaders, { encoding: 'utf8' }).split(/==> .*\.([a-z]*) <==/);
        for (var j = 1; j < spec.length; j += 2) {
          shaderset[spec[j]] = spec[j+1];
        }
      } catch (e) {}
      array[i] = shaderset;
    });
  }

  fs.writeFileSync(config_path, JSON.stringify(config, null, 2));
};


configure()

exports.configure = configure;
